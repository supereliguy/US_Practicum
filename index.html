<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>POCUS Practicum Grading Form</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- html2pdf bundle (html2canvas + jsPDF) -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
    crossorigin="anonymous"
    referrerpolicy="no-referrer">
  </script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #d1d5db; padding: 8px 12px; text-align: left; }
    th { background-color: #f3f4f6; font-weight: 600; }
    tr:nth-child(even) { background-color: #f9fafb; }
    .score-select, .notes-input, .case-select {
      width: 100%; border: 1px solid #d1d5db; border-radius: 4px; padding: 6px 8px;
    }
    .score-select { text-align: center; }
    .total-box { font-size: 1.25rem; font-weight: 600; color: #1a73e8; }
    .vignette-box {
      display: none; margin-top: 0.75rem; padding: 0.75rem 1rem; background-color: #f9fafb;
      border: 1px solid #e5e7eb; border-radius: 0.375rem; font-size: 0.875rem; line-height: 1.4rem; color: #374151;
    }

    /* Print styles (for on-page printing; not used by the summary export) */
    @media print {
      body { margin: 0; padding: 0; }
      .print-hide { display: none !important; }
      .grading-form { box-shadow: none !important; border: none !important; margin: 0 !important; padding: 0 !important; }
      .score-select, .notes-input, .case-select, input[type="text"], select, textarea {
        border: none !important; background: transparent !important; -webkit-appearance: none; appearance: none; padding: 6px 0;
      }
      .score-select { padding-left: 8px; text-align: left; }
      .vignette-box {
        background-color: #f9fafb !important; -webkit-print-color-adjust: exact; color-adjust: exact; display: block !important; line-height: 1.4rem;
      }
      .vignette-box p { margin: 4px 0; }
      h1, h2, h3 { page-break-after: avoid; }
      table { page-break-inside: auto; }
      tr { page-break-inside: avoid; }
    }

    /* ==== SUMMARY PDF (generated on export) ==== */
    #summary-pdf {
      width: 7.5in;                 /* fits inside 0.5" margins on letter */
      padding: 0.25in 0.25in 0.35in;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: #111827;
    }
    #summary-pdf h1 { font-size: 1.1rem; font-weight: 800; margin: 0 0 0.25rem; }
    #summary-pdf h2 { font-size: 0.95rem; font-weight: 700; margin: 0.6rem 0 0.25rem; }
    #summary-pdf .meta { font-size: 0.9rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.25rem 0.75rem; }
    #summary-pdf .meta div span { font-weight: 600; }
    #summary-pdf .twocol { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.35rem; }
    #summary-pdf table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    #summary-pdf th, #summary-pdf td { border: 1px solid #e5e7eb; padding: 6px 8px; vertical-align: top; }
    #summary-pdf th { background: #f9fafb; text-align: left; font-weight: 700; }
    #summary-pdf .totals { text-align: right; font-weight: 800; font-size: 1.1rem; margin-top: 0.4rem; }
    #summary-pdf .grand { font-size: 1.2rem; color: #1a73e8; }
    #summary-pdf .notes { font-size: 0.85rem; white-space: pre-wrap; border: 1px solid #e5e7eb; padding: 8px; background: #fcfcfd; min-height: 1.75rem; }
    #summary-pdf .small { color:#6b7280; font-size: 0.75rem; margin-top: 0.2rem; }
    #summary-pdf .chip { display:inline-block; border:1px solid #e5e7eb; background:#f9fafb; border-radius:6px; padding:2px 6px; font-size:0.75rem; margin-right:6px; }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

  <div id="grading-form" class="grading-form max-w-4xl mx-auto bg-white p-6 sm:p-10 rounded-lg shadow-lg border border-gray-200">
    <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-300">
      <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">EM POCUS Practicum Grading Form</h1>
    </div>

    <!-- Practicum Details -->
    <fieldset class="mb-6">
      <legend class="text-xl font-semibold mb-4 text-gray-700">Practicum Details</legend>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="resident-name" class="block text-sm font-medium text-gray-700 mb-1">Resident Name:</label>
          <input type="text" id="resident-name" class="w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., John Doe">
        </div>
        <div>
          <label for="proctor-name" class="block text-sm font-medium text-gray-700 mb-1">Proctor Name:</label>
          <input type="text" id="proctor-name" class="w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., Dr. Wyatt">
        </div>
        <div>
          <label for="resident-pgy" class="block text-sm font-medium text-gray-700 mb-1">Resident PGY Level:</label>
          <select id="resident-pgy" class="w-full p-2 border border-gray-300 rounded-md">
            <option value="">Select PGY...</option>
            <option value="PGY-1">PGY-1</option>
            <option value="PGY-2">PGY-2</option>
            <option value="PGY-3">PGY-3</option>
          </select>
        </div>
        <div>
          <label for="exam-date" class="block text-sm font-medium text-gray-700 mb-1">Date:</label>
          <input type="date" id="exam-date" class="w-full p-2 border border-gray-300 rounded-md">
        </div>
      </div>
    </fieldset>

    <!-- Scoring Key -->
    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-md">
      <h3 class="font-semibold text-blue-800">Scoring Key:</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <strong class="text-blue-700">Standard Items (0-2 scale):</strong>
          <ul class="list-disc list-inside text-sm text-blue-700">
            <li><strong>2 points:</strong> Performed correctly and independently.</li>
            <li><strong>1 point:</strong> Performed with minor error or required a prompt.</li>
            <li><strong>0 points:</strong> Not performed or performed incorrectly.</li>
          </ul>
        </div>
        <div>
          <strong class="text-blue-700">Interpretation Items (0-5 scale):</strong>
          <ul class="list-disc list-inside text-sm text-blue-700">
            <li><strong>5 points:</strong> Correct, confident, and complete.</li>
            <li><strong>3 points:</strong> Mostly correct, but misses a nuance or requires a minor prompt.</li>
            <li><strong>1 point:</strong> Major error in interpretation.</li>
            <li><strong>0 points:</strong> Incorrect or missed.</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Station 1 -->
    <fieldset class="mb-6">
      <legend class="text-xl font-semibold mb-4 text-gray-700 pb-2 border-b">Station 1</legend>
      <label for="station-1-case" class="block text-sm font-medium text-gray-700 mb-1">Assigned Case:</label>
      <select id="station-1-case" class="case-select mb-4">
        <option value="">Select a case...</option>
        <option value="Case 1: Pericardial Tamponade">Case 1: Pericardial Tamponade</option>
        <option value="Case 2: Massive PE">Case 2: Massive PE</option>
        <option value="Case 3: Pneumothorax">Case 3: Pneumothorax</option>
        <option value="Case 4: Pleural Effusion">Case 4: Pleural Effusion</option>
        <option value="Case 5: Hydronephrosis">Case 5: Hydronephrosis</option>
        <option value="Case 6: Cholecystitis">Case 6: Cholecystitis</option>
        <option value="Case 7: AAA">Case 7: AAA</option>
        <option value="Case 8: Cardiogenic Shock">Case 8: Cardiogenic Shock</option>
      </select>

      <div id="station-1-vignette" class="vignette-box"></div>

      <table class="mt-4">
        <thead>
          <tr>
            <th>Section</th>
            <th>Task</th>
            <th class="w-24">Score</th>
            <th class="w-1/3">Notes</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>A. Exam Selection</td><td>Identifies correct primary exam</td><td><select class="score-select" data-station="1"><option>0</option><option>1</option><option>2</option></select></td><td><input type="text" class="notes-input"></td></tr>
          <tr><td rowspan="5">B. Image Acquisition</td><td>1. Probe Selection</td><td><select class="score-select" data-station="1"><option>0</option><option>1</option><option>2</option></select></td><td><input type="text" class="notes-input"></td></tr>
          <tr><td>2. Machine Setup (Preset, Depth, Gain)</td><td><select class="score-select" data-station="1"><option>0</option><option>1</option><option>2</option></select></td><td><input type="text" class="notes-input"></td></tr>
          <tr><td>3. Patient Positioning</td><td><select class="score-select" data-station="1"><option>0</option><option>1</option><option>2</option></select></td><td><input type="text" class="notes-input"></td></tr>
          <tr><td>4. Image Acquisition (All views)</td><td><select class="score-select" data-station="1"><option>0</option><option>1</option><option>2</option></select></td><td><input type="text" class="notes-input"></td></tr>
          <tr><td>5. Image Optimization (Fine-tuning)</td><td><select class="score-select" data-station="1"><option>0</option><option>1</option><option>2</option></select></td><td><input type="text" class="notes-input"></td></tr>
          <tr><td rowspan="2">C. Interpretation</td><td>1. Anatomy (Identifies key structures)</td>
            <td><select class="score-select" data-station="1"><option>0</option><option>1</option><option>3</option><option>5</option></select></td>
            <td><input type="text" class="notes-input" placeholder="Scored 0-5"></td></tr>
          <tr><td>2. Pathology (Correctly identifies pathology)</td>
            <td><select class="score-select" data-station="1"><option>0</option><option>1</option><option>3</option><option>5</option></select></td>
            <td><input type="text" class="notes-input" placeholder="Scored 0-5"></td></tr>
          <tr><td rowspan="2">D. Clinical Integration</td><td>1. Summary (Provides clear summary)</td><td><select class="score-select" data-station="1"><option>0</option><option>1</option><option>2</option></select></td><td><input type="text" class="notes-input"></td></tr>
          <tr><td>2. MDM (States next critical action)</td><td><select class="score-select" data-station="1"><option>0</option><option>1</option><option>2</option></select></td><td><input type="text" class="notes-input"></td></tr>
        </tbody>
      </table>
      <div class="text-right mt-4">
        <span class="text-lg font-semibold">Station 1 Total:</span>
        <span id="station-1-total" class="total-box">0</span>
        <span class="text-lg font-semibold">/ 26</span>
      </div>
    </fieldset>

    <!-- Station 2 -->
    <fieldset class="mb-6">
      <legend class="text-xl font-semibold mb-4 text-gray-700 pb-2 border-b">Station 2</legend>
      <label for="station-2-case" class="block text-sm font-medium text-gray-700 mb-1">Assigned Case:</label>
      <select id="station-2-case" class="case-select mb-4">
        <option value="">Select a case...</option>
        <option value="Case 1: Pericardial Tamponade">Case 1: Pericardial Tamponade</option>
        <option value="Case 2: Massive PE">Case 2: Massive PE</option>
        <option value="Case 3: Pneumothorax">Case 3: Pneumothorax</option>
        <option value="Case 4: Pleural Effusion">Case 4: Pleural Effusion</option>
        <option value="Case 5: Hydronephrosis">Case 5: Hydronephrosis</option>
        <option value="Case 6: Cholecystitis">Case 6: Cholecystitis</option>
        <option value="Case 7: AAA">Case 7: AAA</option>
        <option value="Case 8: Cardiogenic Shock">Case 8: Cardiogenic Shock</option>
      </select>

      <div id="station-2-vignette" class="vignette-box"></div>

      <table class="mt-4">
        <thead>
          <tr>
            <th>Section</th>
            <th>Task</th>
            <th class="w-24">Score</th>
            <th class="w-1/3">Notes</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>A. Exam Selection</td><td>Identifies correct primary exam</td><td><select class="score-select" data-station="2"><option>0</option><option>1</option><option>2</option></select></td><td><input type="text" class="notes-input"></td></tr>
          <tr><td rowspan="5">B. Image Acquisition</td><td>1. Probe Selection</td><td><select class="score-select" data-station="2"><option>0</option><option>1</option><option>2</option></select></td><td><input type="text" class="notes-input"></td></tr>
          <tr><td>2. Machine Setup (Preset, Depth, Gain)</td><td><select class="score-select" data-station="2"><option>0</option><option>1</option><option>2</option></select></td><td><input type="text" class="notes-input"></td></tr>
          <tr><td>3. Patient Positioning</td><td><select class="score-select" data-station="2"><option>0</option><option>1</option><option>2</option></select></td><td><input type="text" class="notes-input"></td></tr>
          <tr><td>4. Image Acquisition (All views)</td><td><select class="score-select" data-station="2"><option>0</option><option>1</option><option>2</option></select></td><td><input type="text" class="notes-input"></td></tr>
          <tr><td>5. Image Optimization (Fine-tuning)</td><td><select class="score-select" data-station="2"><option>0</option><option>1</option><option>2</option></select></td><td><input type="text" class="notes-input"></td></tr>
          <tr><td rowspan="2">C. Interpretation</td><td>1. Anatomy (Identifies key structures)</td>
            <td><select class="score-select" data-station="2"><option>0</option><option>1</option><option>3</option><option>5</option></select></td>
            <td><input type="text" class="notes-input" placeholder="Scored 0-5"></td></tr>
          <tr><td>2. Pathology (Correctly identifies pathology)</td>
            <td><select class="score-select" data-station="2"><option>0</option><option>1</option><option>3</option><option>5</option></select></td>
            <td><input type="text" class="notes-input" placeholder="Scored 0-5"></td></tr>
          <tr><td rowspan="2">D. Clinical Integration</td><td>1. Summary (Provides clear summary)</td><td><select class="score-select" data-station="2"><option>0</option><option>1</option><option>2</option></select></td><td><input type="text" class="notes-input"></td></tr>
          <tr><td>2. MDM (States next critical action)</td><td><select class="score-select" data-station="2"><option>0</option><option>1</option><option>2</option></select></td><td><input type="text" class="notes-input"></td></tr>
        </tbody>
      </table>
      <div class="text-right mt-4">
        <span class="text-lg font-semibold">Station 2 Total:</span>
        <span id="station-2-total" class="total-box">0</span>
        <span class="text-lg font-semibold">/ 26</span>
      </div>
    </fieldset>

    <!-- Summary -->
    <fieldset class="mt-8 pt-6 border-t border-gray-300">
      <legend class="text-xl font-semibold mb-4 text-gray-700">Summary</legend>
      <div class="p-6 bg-gray-50 rounded-lg border">
        <div class="text-right mb-6">
          <span class="text-2xl font-bold text-gray-800">Grand Total:</span>
          <span id="grand-total" class="total-box text-3xl ml-2">0</span>
          <span class="text-2xl font-bold text-gray-800">/ 52</span>
        </div>
        <div>
          <label for="proctor-feedback" class="block text-sm font-medium text-gray-700 mb-1">Proctor Feedback:</label>
          <textarea id="proctor-feedback" rows="5" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Enter overall feedback, strengths, and areas for improvement..."></textarea>
        </div>
      </div>
    </fieldset>

    <!-- Export -->
    <div class="mt-10 text-center print-hide">
      <button id="export-pdf-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-blue-700 transition duration-200">
        Export as PDF
      </button>
    </div>
  </div>

  <script>
    // --- Case vignettes (for in-page display) ---
    const caseVignettes = {
      "Case 1: Pericardial Tamponade": {
        stem: "Stem: A 55-year-old man with a history of lung cancer presents with shortness of breath, tachycardia, and a blood pressure of 88/60.",
        study: "Cardiac / RUSH Exam",
        findings: "Large circumferential pericardial effusion, diastolic right ventricular (RV) collapse, plethoric/non-collapsing IVC.",
        mdm: "Call for pericardiocentesis tray, cardiology consult, and begin fluid resuscitation."
      },
      "Case 2: Massive PE": {
        stem: "Stem: A 68-year-old woman presents with acute-onset dyspnea and chest pain. She is tachycardic, and her O2 sat is 85%.",
        study: "Cardiac / RUSH Exam",
        findings: "Severely dilated right ventricle (RV > LV), paradoxical septal bowing ('D-sign'), McConnell's sign.",
        mdm: "Administer O2, order STAT CT-PE, and consider thrombolytics."
      },
      "Case 3: Pneumothorax": {
        stem: "Stem: A 22-year-old tall, thin male presents with sudden-onset, sharp left-sided chest pain and shortness of breath.",
        study: "Pulmonary / E-FAST",
        findings: "Absence of lung sliding on the affected side, 'A-lines' only, and (ideally) identification of a 'lung point.'",
        mdm: "Prepare for needle decompression or chest tube."
      },
      "Case 4: Pleural Effusion": {
        stem: "Stem: A 70-year-old woman with a history of breast cancer presents with progressive shortness of breath, cough, and dullness to percussion at the right lung base.",
        study: "Pulmonary",
        findings: "Large anechoic (or complex) fluid collection above the diaphragm, 'spine sign,' and associated lung atelectasis.",
        mdm: "Prepare for diagnostic/therapeutic thoracentesis."
      },
      "Case 5: Hydronephrosis": {
        stem: "Stem: A 40-year-old man presents with 10/10 colicky right flank pain that radiates to his groin, nausea, and vomiting.",
        study: "Renal",
        findings: "Moderate or severe hydronephrosis on the affected side. (Bonus: identifies ureteral jets in the bladder).",
        mdm: "Administer pain control/antiemetics, obtain urinalysis, and consult urology if signs of infection."
      },
      "Case 6: Cholecystitis": {
        stem: "Stem: A 48-year-old woman presents with 12 hours of right upper quadrant pain, fever, and nausea, especially after eating a fatty meal.",
        study: "Gallbladder / RUQ",
        findings: "Gallstones, gallbladder wall thickening (>3mm), pericholecystic fluid, and a Sonographic Murphy's sign.",
        mdm: "Make NPO, administer antibiotics/pain control, and consult general surgery."
      },
      "Case 7: AAA": {
        stem: "Stem: A 72-year-old male with a history of hypertension presents with severe abdominal and back pain and one episode of syncope. He is pale and hypotensive.",
        study: "Aorta / RUSH Exam",
        findings: "Aortic diameter > 3 cm (e.g., 6.5 cm) measured outer-wall to outer-wall, possibly with an intramural thrombus.",
        mdm: "Stop all further diagnostics, establish two large-bore IVs, call vascular surgery emergently, and begin transport to the OR."
      },
      "Case 8: Cardiogenic Shock": {
        stem: "Stem: A 62-year-old man with a history of CAD presents with severe dyspnea, chest discomfort, and altered mental status. He is cold, clammy, and hypotensive (BP 82/55).",
        study: "Cardiac / RUSH Exam",
        findings: "Severely reduced ejection fraction with global hypokinesis, B-lines bilaterally (pulmonary edema), plethoric IVC with minimal collapse (<50%).",
        mdm: "Start inotropic support (e.g., dobutamine), consider IABP, obtain 12-lead ECG, activate cardiology, and prepare for possible cardiac catheterization."
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      // Scoring listeners
      document.querySelectorAll('.score-select').forEach(select => {
        select.addEventListener('change', calculateTotals);
      });

      // Set today's date once
      const dateEl = document.getElementById('exam-date');
      if (dateEl && !dateEl.value) dateEl.valueAsDate = new Date();

      // PDF export
      document.getElementById('export-pdf-btn').addEventListener('click', exportPDF);

      // Vignettes display
      document.getElementById('station-1-case').addEventListener('change', updateVignette);
      document.getElementById('station-2-case').addEventListener('change', updateVignette);
    });

    function calculateTotals() {
      let station1Total = 0, station2Total = 0;
      document.querySelectorAll('[data-station="1"]').forEach(s => station1Total += parseInt(s.value) || 0);
      document.querySelectorAll('[data-station="2"]').forEach(s => station2Total += parseInt(s.value) || 0);
      document.getElementById('station-1-total').textContent = station1Total;
      document.getElementById('station-2-total').textContent = station2Total;
      document.getElementById('grand-total').textContent = station1Total + station2Total;
    }

    function updateVignette(event) {
      const select = event.target;
      const selectedCase = select.value;
      const stationNum = select.id.includes('station-1') ? '1' : '2';
      const container = document.getElementById(`station-${stationNum}-vignette`);
      const data = caseVignettes[selectedCase];

      if (data) {
        container.innerHTML = `
          <p class="italic">${data.stem}</p>
          <hr class="my-2 border-gray-300">
          <p><strong class="font-semibold text-gray-700">Expected Study:</strong> ${data.study}</p>
          <p><strong class="font-semibold text-gray-700">Key Findings:</strong> ${data.findings}</p>
          <p><strong class="font-semibold text-gray-700">Integration (MDM):</strong> ${data.mdm}</p>
        `;
        container.style.display = 'block';
      } else {
        container.innerHTML = '';
        container.style.display = 'none';
      }
    }

    // ===== Summary Export (build compact one-page report and export) =====
    function getStationLabels() {
      return [
        "A. Exam Selection – Correct exam",
        "B1. Probe Selection",
        "B2. Machine Setup",
        "B3. Patient Positioning",
        "B4. Image Acquisition (All views)",
        "B5. Image Optimization",
        "C1. Interpretation – Anatomy",
        "C2. Interpretation – Pathology",
        "D1. Clinical Integration – Summary",
        "D2. Clinical Integration – MDM"
      ];
    }

    function collectStationScores(stationNum) {
      const labels = getStationLabels();
      const selects = Array.from(document.querySelectorAll(`select.score-select[data-station="${stationNum}"]`));
      const rows = selects.map((sel, idx) => ({
        label: labels[idx] || `Item ${idx+1}`,
        score: parseInt(sel.value || "0", 10)
      }));
      const total = rows.reduce((s, r) => s + (Number.isFinite(r.score) ? r.score : 0), 0);
      return { rows, total };
    }

    function getAssignedCase(stationNum) {
      const sel = document.getElementById(`station-${stationNum}-case`);
      return sel && sel.value ? sel.value : "—";
    }

    function buildSummaryNode() {
      // Meta
      const resident = (document.getElementById('resident-name')?.value || '').trim() || '—';
      const proctor  = (document.getElementById('proctor-name')?.value || '').trim()  || '—';
      const pgy      = (document.getElementById('resident-pgy')?.value || '').trim()  || '—';
      const date     = (document.getElementById('exam-date')?.value || '').trim()     || new Date().toISOString().slice(0,10);

      // Scores
      const s1 = collectStationScores(1);
      const s2 = collectStationScores(2);
      const grand = s1.total + s2.total;

      // Cases
      const case1 = getAssignedCase(1);
      const case2 = getAssignedCase(2);

      // Feedback
      const feedbackRaw = (document.getElementById('proctor-feedback')?.value || '').trim();
      const feedback = feedbackRaw.length > 1200 ? (feedbackRaw.slice(0, 1200) + ' …') : feedbackRaw;

      const makeTable = (stationTitle, data, caseName) => {
        const body = data.rows.map(r => `
          <tr><td>${r.label}</td><td style="width:64px; text-align:center; font-weight:700;">${Number.isFinite(r.score) ? r.score : '—'}</td></tr>
        `).join('');
        return `
          <h2>${stationTitle}</h2>
          <div class="small"><span class="chip">${caseName}</span></div>
          <table>
            <thead><tr><th>Item</th><th>Score</th></tr></thead>
            <tbody>${body}</tbody>
          </table>
          <div class="totals">Total: <span class="grand">${data.total}</span> / 26</div>
        `;
      };

      // Build container
      const wrap = document.createElement('div');
      wrap.id = 'summary-pdf';
      wrap.innerHTML = `
        <h1>EM POCUS Practicum – Summary</h1>
        <div class="meta">
          <div><span>Resident:</span> ${resident}</div>
          <div><span>Proctor:</span> ${proctor}</div>
          <div><span>PGY:</span> ${pgy}</div>
          <div><span>Date:</span> ${date}</div>
        </div>

        <div class="twocol">
          <div>${makeTable('Station 1', s1, case1)}</div>
          <div>${makeTable('Station 2', s2, case2)}</div>
        </div>

        <div class="totals" style="margin-top:0.6rem;">
          Grand Total: <span class="grand">${grand}</span> / 52
        </div>

        <h2 style="margin-top:0.6rem;">Proctor Feedback</h2>
        <div class="notes">${feedback || '—'}</div>

        <div class="small">Generated ${new Date().toLocaleString()}</div>
      `;
      return wrap;
    }

    async function exportPDF() {
      const btn = document.getElementById('export-pdf-btn');
      const residentName = (document.getElementById('resident-name')?.value || '').trim();
      const filename = `POCUS-Summary-${residentName ? residentName.replace(/s+/g, '_') : 'Grading'}.pdf`;

      // Build summary node for export. We'll temporarily add it to the DOM,
      // render it, and then remove it.
      const node = buildSummaryNode();
      // We'll position it off-screen so the user doesn't see a flicker.
      node.style.position = 'absolute';
      node.style.top = '-9999px';
      node.style.left = '-9999px';
      document.body.appendChild(node);

      btn.classList.add('print-hide');

      const options = {
        margin: [0.5, 0.5, 0.5, 0.5],    // inches
        filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: {
          scale: 2,
          useCORS: true,
          // The crucial part: html2canvas must render the *node's* dimensions, not the window's
        },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
        pagebreak: { mode: ['avoid-all'] }
      };

      try {
        await html2pdf().set(options).from(node).save();
      } catch (err) {
        console.error('PDF export failed:', err);
        alert('PDF export failed. See console for details.');
      } finally {
        btn.classList.remove('print-hide');
        node.remove(); // cleanup
      }
    }
  </script>
</body>
</html>
